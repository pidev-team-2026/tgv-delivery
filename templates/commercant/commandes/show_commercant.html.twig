{% extends 'commercant/base_commercant.html.twig' %}

{% block title %}Commande {{ commande.reference }} ‚Äî Espace Commer√ßant{% endblock %}

{% block styles %}

{# ‚úÖ CSS MODAL inject√© directement ‚Äî ind√©pendant de livraison.css #}
<style>
/* Badge statuts */
.badge-statut{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:30px;font-weight:700;font-size:0.8rem;}
.s-en_attente    {background:#fef9ec;color:#b45309;border:1.5px solid #fde68a;}
.s-confirmee     {background:#eff6ff;color:#2563eb;border:1.5px solid #bfdbfe;}
.s-en_preparation{background:#fdf4ff;color:#9333ea;border:1.5px solid #e9d5ff;}
.s-prete         {background:#f0fdf9;color:#059669;border:1.5px solid #a7f3d0;}
.s-en_livraison  {background:#fff7ed;color:#ea580c;border:1.5px solid #fed7aa;}
.s-livree        {background:#f0fdf9;color:#00B37E;border:1.5px solid #6ee7b7;}
.s-annulee       {background:#fff1f2;color:#e11d48;border:1.5px solid #fecdd3;}

/* Livreur box */
.livreur-box{display:flex;align-items:center;gap:12px;background:#f0fdf9;border:1.5px solid #d1fae5;border-radius:12px;padding:13px 16px;margin-bottom:6px;}
.btn-desassign{margin-left:auto;background:#fff1f2;border:1.5px solid #fecdd3;color:#e11d48;border-radius:8px;padding:6px 12px;font-size:0.78rem;font-weight:700;cursor:pointer;white-space:nowrap;}
.btn-desassign:hover{background:#ffe4e6;}

/* ‚ïê‚ïê MODAL OVERLAY ‚ïê‚ïê
   display:none par d√©faut, display:flex quand .open est ajout√© */
.lv-overlay{
    position:fixed;inset:0;background:rgba(0,0,0,0.55);
    z-index:99999;
    display:none;          /* cach√© par d√©faut */
    align-items:flex-start;justify-content:center;
    backdrop-filter:blur(6px);padding:20px;overflow-y:auto;
}
/* ‚úÖ LA LIGNE CL√â ‚Äî sans elle le modal ne s'ouvre jamais */
.lv-overlay.open{
    display:flex !important;
}

.lv-modal{
    background:white;border-radius:20px;width:100%;max-width:700px;
    box-shadow:0 32px 80px rgba(0,0,0,0.2);margin:auto;
    animation:lvIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes lvIn{
    from{opacity:0;transform:translateY(28px) scale(0.96);}
    to  {opacity:1;transform:translateY(0)    scale(1);}
}

/* Header modal */
.lv-head{display:flex;align-items:center;gap:12px;padding:20px 24px 16px;border-bottom:1px solid #f0f0f0;border-radius:20px 20px 0 0;}
.lv-head-ico{width:44px;height:44px;border-radius:12px;background:#f0fdf9;color:#00B37E;font-size:1.3rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.lv-head h5{margin:0;font-weight:800;font-size:1rem;}
.lv-head p {margin:0;font-size:0.78rem;color:#999;}
.lv-close  {margin-left:auto;background:#f5f5f5;border:none;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;color:#555;flex-shrink:0;}
.lv-close:hover{background:#e8e8e8;}

/* Body */
.lv-body{padding:20px 24px 24px;}

/* Onglets */
.lv-tabs{display:flex;gap:6px;margin-bottom:16px;}
.lv-tab{flex:1;background:#f5f5f5;border:none;border-radius:10px;padding:10px;font-size:0.84rem;font-weight:700;cursor:pointer;color:#888;display:flex;align-items:center;justify-content:center;gap:7px;transition:all 0.15s;}
.lv-tab.active{background:#1a1a1a;color:white;}
.lv-tab-badge{background:#e8e8e8;border-radius:20px;padding:1px 7px;font-size:0.72rem;color:#555;}
.lv-tab.active .lv-tab-badge{background:rgba(255,255,255,0.2);color:white;}

/* Recherche */
.lv-search{width:100%;border:1.5px solid #ebebeb;border-radius:10px;padding:10px 14px;font-size:0.88rem;outline:none;margin-bottom:14px;transition:border-color 0.15s;box-sizing:border-box;}
.lv-search:focus{border-color:#00B37E;}

/* Grille cartes */
.lv-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media(max-width:500px){.lv-grid{grid-template-columns:1fr;}}

/* Carte livreur */
.lv-card{border:2px solid #f0f0f0;border-radius:14px;padding:14px;cursor:pointer;transition:all 0.15s;position:relative;user-select:none;}
.lv-card *{pointer-events:none;}   /* emp√™che les enfants de bloquer le click */
.lv-card:hover   {border-color:#00B37E;background:#f9fffe;}
.lv-card.selected{border-color:#00B37E;background:#f0fdf9;}
.lv-card.selected::after{content:'‚úì';position:absolute;top:10px;right:12px;background:#00B37E;color:white;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;pointer-events:none;}
.lv-card-top{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.lv-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#00B37E,#059669);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:0.9rem;flex-shrink:0;}
.lv-avatar.p{background:linear-gradient(135deg,#3b82f6,#2563eb);}
.lv-card-name{font-weight:700;font-size:0.88rem;color:#1a1a1a;margin-bottom:2px;}
.lv-card-tel {font-size:0.76rem;color:#aaa;}
.lv-card-tags{display:flex;flex-wrap:wrap;gap:5px;}
.lv-tag{background:#f5f5f5;border-radius:6px;padding:3px 8px;font-size:0.72rem;font-weight:600;color:#555;}
.lv-tag.green{background:#f0fdf9;color:#059669;}
.lv-empty{text-align:center;padding:28px 16px;color:#bbb;font-size:0.84rem;}
.lv-empty i{font-size:2rem;display:block;margin-bottom:8px;}

/* Footer */
.lv-footer{display:flex;gap:10px;padding:16px 24px 20px;border-top:1px solid #f0f0f0;}
.btn-lv-cancel{flex:1;background:#f5f5f5;border:none;border-radius:12px;padding:13px;font-size:0.88rem;font-weight:700;color:#555;cursor:pointer;}
.btn-lv-cancel:hover{background:#ebebeb;}
.btn-lv-ok{flex:2;background:linear-gradient(135deg,#00B37E,#059669);border:none;border-radius:12px;padding:13px;font-size:0.88rem;font-weight:700;color:white;cursor:pointer;box-shadow:0 4px 14px rgba(0,179,126,0.3);display:flex;align-items:center;justify-content:center;gap:7px;transition:opacity 0.15s,transform 0.15s;}
.btn-lv-ok:hover:not(:disabled){opacity:0.9;transform:translateY(-1px);}
.btn-lv-ok:disabled{background:#ccc;box-shadow:none;cursor:not-allowed;transform:none;}

/* Toast */
.cm-toast{position:fixed;bottom:24px;right:24px;background:#1a1a1a;color:white;padding:12px 20px;border-radius:12px;font-size:0.88rem;font-weight:500;box-shadow:0 8px 32px rgba(0,0,0,0.2);z-index:999999;display:flex;align-items:center;gap:8px;transform:translateY(80px);opacity:0;transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);pointer-events:none;}
.cm-toast.show{transform:translateY(0);opacity:1;}
</style>
{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1><i class="bi bi-clipboard-check"></i> Commande {{ commande.reference }}</h1>
        <p class="text-muted mb-0">Cr√©√©e le {{ commande.dateCreation|date('d/m/Y √† H:i') }}</p>
    </div>
    <a href="{{ path('wajih_commercant_commandes') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Retour
    </a>
</div>

{% for type, msgs in app.flashes %}{% for m in msgs %}
<div class="alert alert-{{ type }} alert-dismissible fade show">{{ m }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
{% endfor %}{% endfor %}

<div class="row g-3">

    {# ‚îÄ‚îÄ COLONNE GAUCHE ‚îÄ‚îÄ #}
    <div class="col-md-8">

        {# INFO COMMANDE #}
        <div class="card mb-3">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informations commande</h5>
                <span class="badge-statut s-{{ commande.statut }}">
                    {% if commande.statut=='en_attente' %}<i class="bi bi-hourglass-split"></i> En attente
                    {% elseif commande.statut=='confirmee' %}<i class="bi bi-check-circle"></i> Confirm√©e
                    {% elseif commande.statut=='en_preparation' %}<i class="bi bi-box-seam"></i> En pr√©paration
                    {% elseif commande.statut=='prete' %}<i class="bi bi-bag-check"></i> Pr√™te
                    {% elseif commande.statut=='en_livraison' %}<i class="bi bi-truck"></i> En livraison
                    {% elseif commande.statut=='livree' %}<i class="bi bi-check2-circle"></i> Livr√©e
                    {% elseif commande.statut=='annulee' %}<i class="bi bi-x-circle"></i> Annul√©e
                    {% endif %}
                </span>
            </div>
            <div class="card-body">
                <table class="table table-striped mb-0">
                    <tbody>
                        <tr><th width="30%">R√©f√©rence</th><td><strong>{{ commande.reference }}</strong></td></tr>
                        <tr><th>Total</th><td><span class="text-success fw-bold fs-5">{{ commande.getMontantTotal()|number_format(3,',','') }} TND</span></td></tr>
                        <tr><th>Frais livraison</th><td>{{ commande.fraisLivraison|number_format(3,',','') }} TND</td></tr>
                        {% if commande.remise > 0 %}
                        <tr><th>Remise</th><td class="text-success">‚àí{{ commande.remise|number_format(3,',','') }} TND {% if commande.codePromo %}<span class="badge bg-success">{{ commande.codePromo }}</span>{% endif %}</td></tr>
                        {% endif %}
                        <tr>
                            <th>Paiement</th>
                            <td>
                                {% if commande.modePaiement=='especes' %}<span class="badge bg-warning text-dark">üíµ Esp√®ces</span>
                                {% elseif commande.modePaiement=='carte' %}<span class="badge bg-info">üí≥ Carte</span>
                                {% elseif commande.modePaiement=='virement' %}<span class="badge bg-primary">üè¶ Virement</span>{% endif %}
                                {% if commande.isPaiementEffectue() %}<span class="badge bg-success ms-1">Pay√© ‚úì</span>{% else %}<span class="badge bg-danger ms-1">Non pay√©</span>{% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {# CLIENT #}
        <div class="card mb-3">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-person"></i> Client</h5></div>
            <div class="card-body">
                <table class="table table-striped mb-0">
                    <tbody>
                        <tr><th width="30%">Nom</th><td><strong>{{ commande.nomClient }}</strong></td></tr>
                        <tr><th>T√©l√©phone</th><td>{{ commande.telephone }}</td></tr>
                        <tr><th>Email</th><td>{{ commande.email ?? '‚Äî' }}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        {# ADRESSE #}
        <div class="card mb-3">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-geo-alt"></i> Adresse de livraison</h5></div>
            <div class="card-body">
                <table class="table table-striped mb-0">
                    <tbody>
                        {% if commande.gouvernorat %}
                        <tr><th width="30%">Gouvernorat</th><td>{{ commande.gouvernorat }}</td></tr>
                        {% endif %}
                        <tr><th width="30%">Adresse</th><td>{{ commande.adresseLivraison }}</td></tr>
                        <tr><th>Ville</th><td>{{ commande.ville }}</td></tr>
                        <tr><th>Code postal</th><td>{{ commande.codePostal }}</td></tr>
                        {% if commande.estimationLivraison %}
                        <tr><th>Estimation</th><td class="text-success fw-bold"><i class="bi bi-clock"></i>
                            {% set m = commande.estimationLivraison %}
                            {% if m < 60 %}{{ m }} min{% else %}{{ (m/60)|round(0,'floor') }}h{{ m%60 > 0 ? '%02d'|format(m%60) : '' }}{% endif %}
                        </td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        {# ARTICLES #}
        <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-box"></i> Articles command√©s</h5></div>
            <div class="card-body">
                {% set items = [] %}
                {% if commande.notes %}{% set p = commande.notes|json_encode %}{% if p is iterable %}{% set items = p %}{% endif %}{% endif %}
                {% if items|length > 0 %}
                <table class="table">
                    <thead><tr><th>Article</th><th>Qt√©</th><th class="text-end">Prix</th></tr></thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    {% if item.image is defined and item.image %}<img src="{{ item.image }}" style="width:36px;height:36px;object-fit:cover;border-radius:8px;">
                                    {% else %}<div style="width:36px;height:36px;background:#f5f5f5;border-radius:8px;display:flex;align-items:center;justify-content:center;">üõçÔ∏è</div>{% endif %}
                                    <strong>{{ item.name ?? item.nom ?? 'Produit' }}</strong>
                                </div>
                            </td>
                            <td>√ó {{ item.qty ?? item.quantite ?? 1 }}</td>
                            <td class="text-end fw-bold text-success">{{ ((item.price ?? item.prix ?? 0) * (item.qty ?? item.quantite ?? 1))|number_format(3,',','') }} TND</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr><th colspan="2" class="text-end">Total :</th><th class="text-end text-success">{{ commande.getMontantTotal()|number_format(3,',','') }} TND</th></tr>
                    </tfoot>
                </table>
                {% else %}
                <p class="text-muted text-center py-3">Aucun d√©tail d'article disponible.</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# ‚îÄ‚îÄ COLONNE DROITE ‚Äî ACTIONS ‚îÄ‚îÄ #}
    <div class="col-md-4">

        {# LIVREUR ASSIGN√â #}
        <div class="card mb-3">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="mb-0"><i class="bi bi-truck"></i> Livreur assign√©</h5>
                {% if commande.statut != 'livree' and commande.statut != 'annulee' %}
                <button class="btn btn-sm btn-success" onclick="openModal()">
                    <i class="bi bi-plus-lg"></i> Assigner
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if commande.livreur %}
                <div class="livreur-box" id="livreurBox">
                    <i class="bi bi-person-fill-check text-success fs-4"></i>
                    <div>
                        <div class="fw-bold" id="lvNom">{{ commande.livreur.nomComplet }}</div>
                        <div class="text-muted small" id="lvTel">{{ commande.livreur.telephone }}</div>
                        <div class="small">{{ commande.livreur.vehiculeLibelle }} ¬∑ {{ commande.livreur.typeLibelle }}</div>
                    </div>
                    {% if commande.statut != 'livree' %}
                    <form method="POST" action="{{ path('app_commercant_commande_desassign_livreur',{'id':commande.id}) }}" class="ms-auto">
                        <input type="hidden" name="_token" value="{{ csrf_token('desassign'~commande.id) }}">
                        <button type="submit" class="btn-desassign" onclick="return confirm('D√©sassigner ?')">
                            <i class="bi bi-x"></i> Lib√©rer
                        </button>
                    </form>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-center text-muted py-3" id="livreurVide">
                    <i class="bi bi-person-x fs-3 d-block mb-2"></i>
                    Aucun livreur assign√©
                    {% if commande.statut != 'livree' and commande.statut != 'annulee' %}
                    <br><button class="btn btn-sm btn-outline-success mt-2" onclick="openModal()">
                        <i class="bi bi-truck"></i> Assigner un livreur
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        {# ACTIONS #}
        <div class="card mb-3">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-gear"></i> Actions</h5></div>
            <div class="card-body d-grid gap-2">
                {% if commande.statut == 'en_attente' %}
                <form method="POST" action="{{ path('wajih_commercant_commande_confirm',{'id':commande.id}) }}">
                    <input type="hidden" name="_token" value="{{ csrf_token('confirm'~commande.id) }}">
                    <button class="btn btn-success w-100"><i class="bi bi-check-lg"></i> Confirmer</button>
                </form>
                {% endif %}
                {% if commande.statut != 'livree' and commande.statut != 'annulee' %}
                <div class="dropdown">
                    <button class="btn btn-warning dropdown-toggle w-100" data-bs-toggle="dropdown">
                        <i class="bi bi-arrow-repeat"></i> Changer le statut
                    </button>
                    <ul class="dropdown-menu w-100">
                        {% for s in [
                            {v:'en_attente',     i:'bi-hourglass',    l:'En attente'},
                            {v:'confirmee',      i:'bi-check-circle', l:'Confirm√©e'},
                            {v:'en_preparation', i:'bi-box-seam',     l:'En pr√©paration'},
                            {v:'prete',          i:'bi-bag-check',    l:'Pr√™te'},
                            {v:'en_livraison',   i:'bi-truck',        l:'En livraison'},
                            {v:'livree',         i:'bi-check2-all',   l:'Livr√©e'},
                        ] %}
                        {% if s.v != commande.statut %}
                        <li>
                            <form method="POST" action="{{ path('wajih_commercant_commande_status',{'id':commande.id}) }}">
                                <input type="hidden" name="status" value="{{ s.v }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('status'~commande.id) }}">
                                <button class="dropdown-item"><i class="bi {{ s.i }}"></i> {{ s.l }}</button>
                            </form>
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                <form method="POST" action="{{ path('wajih_commercant_commande_cancel',{'id':commande.id}) }}"
                      onsubmit="return confirm('Annuler cette commande ?')">
                    <input type="hidden" name="_token" value="{{ csrf_token('cancel'~commande.id) }}">
                    <button class="btn btn-danger w-100"><i class="bi bi-x-circle"></i> Annuler</button>
                </form>
                {% endif %}
            </div>
        </div>

        {# STATS LIVREURS #}
        <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-people"></i> Livreurs disponibles</h5></div>
            <div class="card-body">
                <div class="d-flex justify-content-around text-center">
                    <div>
                        <div class="fs-3 fw-bold text-success">{{ livreursPropres|length }}</div>
                        <div class="small text-muted">Internes</div>
                    </div>
                    <div class="vr"></div>
                    <div>
                        <div class="fs-3 fw-bold text-primary">{{ livreursPartenaires|length }}</div>
                        <div class="small text-muted">Partenaires</div>
                    </div>
                    <div class="vr"></div>
                    <div>
                        <div class="fs-3 fw-bold">{{ livreursPropres|length + livreursPartenaires|length }}</div>
                        <div class="small text-muted">Total</div>
                    </div>
                </div>
                <a href="{{ path('app_commercant_livreurs') }}" class="btn btn-outline-secondary w-100 mt-3 btn-sm">
                    <i class="bi bi-list-ul"></i> G√©rer les livreurs
                </a>
            </div>
        </div>
    </div>
</div>

{# ‚ïê‚ïê MODAL ASSIGNATION ‚ïê‚ïê #}
<div class="lv-overlay" id="lvOverlay">
    <div class="lv-modal">
        <div class="lv-head">
            <div class="lv-head-ico"><i class="bi bi-truck"></i></div>
            <div><h5>Assigner un livreur</h5><p>{{ commande.reference }}</p></div>
            <button class="lv-close" onclick="closeModal()"><i class="bi bi-x"></i></button>
        </div>

        <div class="lv-body">
            <div class="lv-tabs">
                <button class="lv-tab active" id="tabP" onclick="switchTab('propres')">
                    <i class="bi bi-person-badge"></i> Internes
                    <span class="lv-tab-badge" id="cntP">{{ livreursPropres|length }}</span>
                </button>
                <button class="lv-tab" id="tabA" onclick="switchTab('partenaires')">
                    <i class="bi bi-building"></i> Partenaires
                    <span class="lv-tab-badge" id="cntA">{{ livreursPartenaires|length }}</span>
                </button>
            </div>

            <input type="text" class="lv-search" id="lvSearch"
                   placeholder="Rechercher par nom, t√©l√©phone, zone..."
                   oninput="filterCards(this.value)">

            {# PROPRES #}
            <div id="panelP">
                {% if livreursPropres|length > 0 %}
                <div class="lv-grid">
                    {% for l in livreursPropres %}
                    <div class="lv-card {{ commande.livreur and commande.livreur.id == l.id ? 'selected' : '' }}"
                         data-id="{{ l.id }}"
                         data-nom="{{ l.nomComplet }}"
                         data-tel="{{ l.telephone }}"
                         data-search="{{ (l.nomComplet ~ ' ' ~ l.telephone ~ ' ' ~ (l.zonesCouvertes ?? ''))|lower }}">
                        <div class="lv-card-top">
                            <div class="lv-avatar">{{ l.prenom|slice(0,1) }}{{ l.nom|slice(0,1) }}</div>
                            <div>
                                <div class="lv-card-name">{{ l.nomComplet }}</div>
                                <div class="lv-card-tel">{{ l.telephone }}</div>
                            </div>
                        </div>
                        <div class="lv-card-tags">
                            <span class="lv-tag">{{ l.vehiculeLibelle }}</span>
                            {% if l.zonesCouvertes %}<span class="lv-tag green"><i class="bi bi-geo-alt"></i> {{ l.zonesCouvertes }}</span>{% endif %}
                            {% if l.note %}<span class="lv-tag">‚≠ê {{ l.note|number_format(1) }}</span>{% endif %}
                            <span class="lv-tag">{{ l.nombreLivraisons }} livr.</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="lv-empty"><i class="bi bi-person-x"></i> Aucun livreur interne disponible.</div>
                {% endif %}
            </div>

            {# PARTENAIRES #}
            <div id="panelA" style="display:none;">
                {% if livreursPartenaires|length > 0 %}
                <div class="lv-grid">
                    {% for l in livreursPartenaires %}
                    <div class="lv-card {{ commande.livreur and commande.livreur.id == l.id ? 'selected' : '' }}"
                         data-id="{{ l.id }}"
                         data-nom="{{ l.nomComplet }}"
                         data-tel="{{ l.telephone }}"
                         data-search="{{ (l.nomComplet ~ ' ' ~ l.telephone ~ ' ' ~ (l.zonesCouvertes ?? '') ~ ' ' ~ (l.societePartenaire ?? ''))|lower }}">
                        <div class="lv-card-top">
                            <div class="lv-avatar p">
                                {% if l.societePartenaire %}{{ l.societePartenaire|slice(0,2)|upper }}{% else %}{{ l.prenom|slice(0,1) }}{{ l.nom|slice(0,1) }}{% endif %}
                            </div>
                            <div>
                                <div class="lv-card-name">{{ l.societePartenaire ?? l.nomComplet }}</div>
                                <div class="lv-card-tel">{{ l.telephone }}</div>
                            </div>
                        </div>
                        <div class="lv-card-tags">
                            <span class="lv-tag">{{ l.vehiculeLibelle }}</span>
                            {% if l.zonesCouvertes %}<span class="lv-tag green"><i class="bi bi-geo-alt"></i> {{ l.zonesCouvertes }}</span>{% endif %}
                            {% if l.note %}<span class="lv-tag">‚≠ê {{ l.note|number_format(1) }}</span>{% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="lv-empty"><i class="bi bi-building-x"></i> Aucun partenaire disponible.</div>
                {% endif %}
            </div>
        </div>

        <div class="lv-footer">
            <button class="btn-lv-cancel" onclick="closeModal()"><i class="bi bi-x"></i> Annuler</button>
            <button class="btn-lv-ok" id="btnOk" disabled onclick="confirmer()">
                <i class="bi bi-check-lg"></i> Assigner ce livreur
            </button>
        </div>
    </div>
</div>

<div class="cm-toast" id="toast">
    <i class="bi bi-check-circle-fill" style="color:#00B37E;"></i>
    <span id="toastMsg"></span>
</div>

<script>
let selectedId  = null;

// ‚îÄ‚îÄ Ouvrir / Fermer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal() {
    document.getElementById('lvOverlay').classList.add('open');
}
function closeModal() {
    document.getElementById('lvOverlay').classList.remove('open');
    selectedId = null;
    document.querySelectorAll('.lv-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('btnOk').disabled = true;
}
document.getElementById('lvOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

// ‚îÄ‚îÄ Click cartes ‚Äî closest() pour √©viter le bug enfants ‚îÄ‚îÄ
document.querySelectorAll('.lv-card').forEach(function(card) {
    card.addEventListener('click', function(e) {
        const c = e.target.closest('.lv-card');
        if (!c) return;
        document.querySelectorAll('.lv-card').forEach(x => x.classList.remove('selected'));
        c.classList.add('selected');
        selectedId = c.dataset.id;
        console.log('‚úÖ Livreur s√©lectionn√© id=', selectedId);
        document.getElementById('btnOk').disabled = false;
    });
});

// ‚îÄ‚îÄ Onglets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(t) {
    document.getElementById('panelP').style.display = t === 'propres'     ? '' : 'none';
    document.getElementById('panelA').style.display = t === 'partenaires' ? '' : 'none';
    document.getElementById('tabP').classList.toggle('active', t === 'propres');
    document.getElementById('tabA').classList.toggle('active', t === 'partenaires');
    document.getElementById('lvSearch').value = '';
    filterCards('');
}

// ‚îÄ‚îÄ Filtre ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterCards(q) {
    document.querySelectorAll('.lv-card').forEach(function(c) {
        c.style.display = c.dataset.search.includes(q.toLowerCase()) ? '' : 'none';
    });
}

// ‚îÄ‚îÄ Confirmer assignation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmer() {
    if (!selectedId) { showToast('‚ùå S√©lectionnez un livreur.'); return; }

    const btn = document.getElementById('btnOk');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Assignation...';

    const fd = new FormData();
    fd.append('livreur_id', selectedId);
    fd.append('_token', '{{ csrf_token("assign" ~ commande.id) }}');

    console.log('POST livreur_id=', selectedId);

    fetch('{{ path("app_commercant_commande_assign_livreur", {"id": commande.id}) }}', {
        method: 'POST',
        body: fd
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            closeModal();
            showToast('‚úÖ ' + res.message);
            setTimeout(() => location.reload(), 1800);
        } else {
            showToast('‚ùå ' + res.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-lg"></i> Assigner ce livreur';
        }
    })
    .catch(err => {
        console.error(err);
        showToast('‚ùå Erreur r√©seau.');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg"></i> Assigner ce livreur';
    });
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3500);
}
</script>
{% endblock %}
