{% extends 'commercant/base_commercant.html.twig' %}

{% block title %}Contacter le client - Espace Commerçant{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1><i class="bi bi-envelope"></i> Contacter le client</h1>
        <p class="text-muted">Envoyer un message au client pour la commande : {{ commande.reference }}</p>
    </div>
    <a href="{{ path('app_commercant_commandes') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Retour aux commandes
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-envelope-paper"></i> Nouveau message</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{{ path('app_commercant_commande_contact', {'id': commande.id}) }}">
                    <input type="hidden" name="_token" value="{{ csrf_token('contact' ~ commande.id) }}">
                    
                    <!-- INFORMATIONS CLIENT -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="bi bi-person"></i> Informations du client</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Nom</label>
                                    <input type="text" class="form-control" value="{{ commande.nomClient }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Téléphone</label>
                                    <input type="text" class="form-control" value="{{ commande.telephone }}" readonly>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" value="{{ commande.email ?: 'Non spécifié' }}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- INFORMATIONS COMMANDE -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="bi bi-clipboard-check"></i> Détails de la commande</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Référence</label>
                                    <input type="text" class="form-control" value="{{ commande.reference }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Total</label>
                                    <input type="text" class="form-control" value="{{ commande.totalPrix }}€" readonly>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <label class="form-label">Statut actuel</label>
                                    <div>
                                        {% if commande.statut == 'en_attente' %}
                                            <span class="badge bg-warning">En attente</span>
                                        {% elseif commande.statut == 'confirmee' %}
                                            <span class="badge bg-info">Confirmée</span>
                                        {% elseif commande.statut == 'en_preparation' %}
                                            <span class="badge bg-primary">En préparation</span>
                                        {% elseif commande.statut == 'prete' %}
                                            <span class="badge bg-info">Prête</span>
                                        {% elseif commande.statut == 'en_livraison' %}
                                            <span class="badge bg-primary">En livraison</span>
                                        {% elseif commande.statut == 'livree' %}
                                            <span class="badge bg-success">Livrée</span>
                                        {% elseif commande.statut == 'annulee' %}
                                            <span class="badge bg-danger">Annulée</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MESSAGE -->
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="bi bi-chat-text"></i> Message à envoyer</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="message" class="form-label">Votre message *</label>
                                <textarea name="message" id="message" class="form-control" rows="6" 
                                          placeholder="Tapez votre message ici..." required></textarea>
                            </div>
                            
                            <!-- TEMPLATES RAPIDES -->
                            <div class="mb-3">
                                <label class="form-label">Modèles rapides</label>
                                <div class="btn-group-vertical w-100" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm mb-1 text-start" 
                                            onclick="setMessageTemplate('confirm')">
                                        <i class="bi bi-check-circle"></i> Confirmation de commande
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm mb-1 text-start" 
                                            onclick="setMessageTemplate('preparation')">
                                        <i class="bi bi-gear"></i> Début de préparation
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm mb-1 text-start" 
                                            onclick="setMessageTemplate('livraison')">
                                        <i class="bi bi-truck"></i> Début de livraison
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm mb-1 text-start" 
                                            onclick="setMessageTemplate('delay')">
                                        <i class="bi bi-clock"></i> Information de retard
                                    </button>
                                </div>
                            </div>
                            
                            <div class="text-end">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-send"></i> Envoyer le message
                                </button>
                                <a href="{{ path('app_commercant_commandes') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Annuler
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- HISTORIQUE -->
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clock-history"></i> Historique</h5>
            </div>
            <div class="card-body">
                <h6>Informations temporelles</h6>
                <ul class="small">
                    <li><strong>Création :</strong> {{ commande.dateCreation|date('d/m/Y H:i') }}</li>
                    {% if commande.dateLivraisonSouhaitee %}
                        <li><strong>Livraison souhaitée :</strong> {{ commande.dateLivraisonSouhaitee|date('d/m/Y H:i') }}</li>
                    {% endif %}
                    {% if commande.dateLivraisonEffective %}
                        <li><strong>Livraison effective :</strong> {{ commande.dateLivraisonEffective|date('d/m/Y H:i') }}</li>
                    {% endif %}
                    <li><strong>Dernière mise à jour :</strong> {{ commande.dateMisAjour|date('d/m/Y H:i') }}</li>
                </ul>
            </div>
        </div>
        
        <!-- CONSEILS -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> Conseils</h5>
            </div>
            <div class="card-body">
                <h6>Communication efficace :</h6>
                <ul class="small">
                    <li>Soyez clair et précis dans vos messages</li>
                    <li>Indiquez toujours la référence de la commande</li>
                    <li>Prévenez en cas de retard ou de problème</li>
                    <li>Confirmez la disponibilité avant la livraison</li>
                    <li>Soyez courtois et professionnel</li>
                </ul>
                
                <h6 class="mt-3">Templates disponibles :</h6>
                <ul class="small">
                    <li><strong>Confirmation :</strong> Pour valider la commande</li>
                    <li><strong>Préparation :</strong> Pour informer du début</li>
                    <li><strong>Livraison :</strong> Pour annoncer l'envoi</li>
                    <li><strong>Retard :</strong> Pour prévenir d'un problème</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
function setMessageTemplate(type) {
    const messageField = document.getElementById('message');
    const commandeRef = '{{ commande.reference }}';
    const clientName = '{{ commande.nomClient }}';
    
    const templates = {
        confirm: `Bonjour ${clientName},\n\nVotre commande ${commandeRef} a été confirmée et est maintenant en préparation.\n\nDétails :\n- Total : {{ commande.totalPrix }}€\n- Statut : Confirmée\n\nNous vous tiendrons informé de l'avancement.\n\nCordialement,\nL'équipe TGV Delivery`,
        
        preparation: `Bonjour ${clientName},\n\nVotre commande ${commandeRef} est maintenant en préparation.\n\nTemps estimé : 30-45 minutes\n\nNous vous informerons dès qu'elle sera prête pour la livraison.\n\nCordialement,\nL'équipe TGV Delivery`,
        
        livraison: `Bonjour ${clientName},\n\nVotre commande ${commandeRef} a été confiée à notre livreur.\n\nDélai de livraison : 15-30 minutes\n\nVous pouvez suivre votre commande en temps réel.\n\nCordialement,\nL'équipe TGV Delivery`,
        
        delay: `Bonjour ${clientName},\n\nNous vous contactons concernant votre commande ${commandeRef}.\n\nUn léger retard est prévu. Nouvelle estimation : 45-60 minutes.\n\nNous nous excusons pour la gêne occasionnée et vous remercions de votre patience.\n\nCordialement,\nL'équipe TGV Delivery`
    };
    
    messageField.value = templates[type] || '';
}
</script>
{% endblock %}
