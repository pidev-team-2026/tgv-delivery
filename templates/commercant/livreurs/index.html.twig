{% extends 'commercant/base_commercant.html.twig' %}

{% block title %}Gestion des Livreurs — Espace Commerçant{% endblock %}

{% block styles %}
<style>
.lv-stat-cards { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:24px; }
@media(max-width:768px){ .lv-stat-cards { grid-template-columns:1fr 1fr; } }
.lv-stat {
    background:white; border-radius:14px; padding:18px 20px;
    border:1.5px solid #f0f0f0; box-shadow:0 2px 8px rgba(0,0,0,0.04);
    display:flex; align-items:center; gap:14px;
}
.lv-stat-ico {
    width:48px; height:48px; border-radius:12px;
    display:flex; align-items:center; justify-content:center;
    font-size:1.3rem; flex-shrink:0;
}
.ico-green  { background:#f0fdf9; color:#00B37E; }
.ico-orange { background:#fff7ed; color:#ea580c; }
.ico-gray   { background:#f5f5f5; color:#888; }
.ico-blue   { background:#eff6ff; color:#3b82f6; }
.lv-stat-val { font-family:'Syne',sans-serif; font-weight:800; font-size:1.6rem; color:#1a1a1a; line-height:1; }
.lv-stat-lbl { font-size:0.75rem; color:#aaa; margin-top:2px; }

/* Badge statut */
.badge-statut-lv { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:20px; font-size:0.76rem; font-weight:700; }
.bs-disponible  { background:#f0fdf9; color:#059669; border:1px solid #a7f3d0; }
.bs-occupe      { background:#fff7ed; color:#ea580c; border:1px solid #fed7aa; }
.bs-inactif     { background:#f5f5f5; color:#aaa;    border:1px solid #e5e7eb; }

/* Badge type */
.badge-type { display:inline-flex; align-items:center; gap:5px; padding:3px 9px; border-radius:20px; font-size:0.72rem; font-weight:600; }
.bt-propre     { background:#eff6ff; color:#2563eb; }
.bt-partenaire { background:#fdf4ff; color:#9333ea; }

/* Table row hover */
.table-livreurs tbody tr:hover { background:#fafbff; }

/* Dropdown statut inline */
.stat-form { display:inline; }
</style>
{% endblock %}

{% block body %}

<div class="page-header">
    <div>
        <h1><i class="bi bi-people"></i> Gestion des Livreurs</h1>
        <p class="text-muted mb-0">Livreurs internes et partenaires</p>
    </div>
    <a href="{{ path('app_commercant_livreur_new') }}" class="btn btn-success">
        <i class="bi bi-plus-lg"></i> Ajouter un livreur
    </a>
</div>

{% for type, msgs in app.flashes %}{% for m in msgs %}
<div class="alert alert-{{ type }} alert-dismissible fade show">{{ m }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
{% endfor %}{% endfor %}

{# ── STATS ── #}
{% set nbDispo    = livreursPropres|length + livreursPartenaires|length %}
{% set nbOccupes  = livreursOccupes|length %}
{% set nbInactifs = livreursInactifs|length %}
{% set nbTotal    = tous|length %}

<div class="lv-stat-cards">
    <div class="lv-stat">
        <div class="lv-stat-ico ico-green"><i class="bi bi-check-circle"></i></div>
        <div><div class="lv-stat-val">{{ nbDispo }}</div><div class="lv-stat-lbl">Disponibles</div></div>
    </div>
    <div class="lv-stat">
        <div class="lv-stat-ico ico-orange"><i class="bi bi-truck"></i></div>
        <div><div class="lv-stat-val">{{ nbOccupes }}</div><div class="lv-stat-lbl">En livraison</div></div>
    </div>
    <div class="lv-stat">
        <div class="lv-stat-ico ico-gray"><i class="bi bi-slash-circle"></i></div>
        <div><div class="lv-stat-val">{{ nbInactifs }}</div><div class="lv-stat-lbl">Inactifs</div></div>
    </div>
    <div class="lv-stat">
        <div class="lv-stat-ico ico-blue"><i class="bi bi-people"></i></div>
        <div><div class="lv-stat-val">{{ nbTotal }}</div><div class="lv-stat-lbl">Total</div></div>
    </div>
</div>

{# ── TABLEAU ── #}
<div class="card">
    <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Tous les livreurs</h5>
        <div class="d-flex gap-2">
            <input type="text" class="form-control form-control-sm" id="searchInput"
                   placeholder="Rechercher..." style="width:220px;" oninput="filterTable(this.value)">
        </div>
    </div>
    <div class="card-body p-0">
        {% if tous|length > 0 %}
        <div class="table-responsive">
            <table class="table table-hover mb-0 table-livreurs" id="livreurTable">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Nom</th>
                        <th>Téléphone</th>
                        <th>Type</th>
                        <th>Véhicule</th>
                        <th>Zones</th>
                        <th>Livraisons</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for l in tous %}
                    <tr data-search="{{ (l.nomComplet ~ ' ' ~ l.telephone ~ ' ' ~ (l.zonesCouvertes ?? '') ~ ' ' ~ (l.societePartenaire ?? ''))|lower }}">
                        <td class="text-muted small">{{ l.id }}</td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div style="width:36px;height:36px;border-radius:50%;
                                     background:{{ l.type=='propre' ? 'linear-gradient(135deg,#00B37E,#059669)' : 'linear-gradient(135deg,#3b82f6,#2563eb)' }};
                                     display:flex;align-items:center;justify-content:center;
                                     color:white;font-weight:800;font-size:0.78rem;flex-shrink:0;">
                                    {{ l.prenom|slice(0,1) }}{{ l.nom|slice(0,1) }}
                                </div>
                                <div>
                                    <div class="fw-bold small">{{ l.nomComplet }}</div>
                                    {% if l.societePartenaire %}<div class="text-muted" style="font-size:0.72rem;">{{ l.societePartenaire }}</div>{% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="small">{{ l.telephone }}</td>
                        <td>
                            <span class="badge-type bt-{{ l.type }}">
                                {% if l.type=='propre' %}<i class="bi bi-person-badge"></i> Interne
                                {% else %}<i class="bi bi-building"></i> Partenaire{% endif %}
                            </span>
                        </td>
                        <td class="small">{{ l.vehiculeLibelle }}</td>
                        <td class="small text-muted">{{ l.zonesCouvertes ?? '—' }}</td>
                        <td class="text-center">
                            <span class="badge bg-secondary">{{ l.nombreLivraisons }}</span>
                        </td>
                        <td>
                            <span class="badge-statut-lv bs-{{ l.statut }}">
                                {% if l.statut=='disponible' %}<i class="bi bi-check-circle"></i> Disponible
                                {% elseif l.statut=='occupe' %}<i class="bi bi-truck"></i> En livraison
                                {% else %}<i class="bi bi-slash-circle"></i> Inactif{% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex gap-1 align-items-center">
                                {# Changer statut #}
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Changer statut">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        {% if l.statut != 'disponible' %}
                                        <li>
                                            <form class="stat-form" method="POST" action="{{ path('app_commercant_livreur_statut',{'id':l.id}) }}">
                                                <input type="hidden" name="statut" value="disponible">
                                                <button class="dropdown-item text-success"><i class="bi bi-check-circle"></i> Disponible</button>
                                            </form>
                                        </li>
                                        {% endif %}
                                        {% if l.statut != 'occupe' %}
                                        <li>
                                            <form class="stat-form" method="POST" action="{{ path('app_commercant_livreur_statut',{'id':l.id}) }}">
                                                <input type="hidden" name="statut" value="occupe">
                                                <button class="dropdown-item text-warning"><i class="bi bi-truck"></i> Occupé</button>
                                            </form>
                                        </li>
                                        {% endif %}
                                        {% if l.statut != 'inactif' %}
                                        <li>
                                            <form class="stat-form" method="POST" action="{{ path('app_commercant_livreur_statut',{'id':l.id}) }}">
                                                <input type="hidden" name="statut" value="inactif">
                                                <button class="dropdown-item text-secondary"><i class="bi bi-slash-circle"></i> Inactif</button>
                                            </form>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>

                                {# Supprimer #}
                                <form method="POST" action="{{ path('app_commercant_livreur_delete',{'id':l.id}) }}"
                                      onsubmit="return confirm('Supprimer ' + '{{ l.nomComplet }}' + ' ?')">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete_livreur'~l.id) }}">
                                    <button class="btn btn-sm btn-outline-danger" title="Supprimer">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-5">
            <i class="bi bi-people fs-1 d-block mb-3 opacity-25"></i>
            <p>Aucun livreur enregistré.</p>
            <a href="{{ path('app_commercant_livreur_new') }}" class="btn btn-success">
                <i class="bi bi-plus-lg"></i> Ajouter le premier livreur
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
function filterTable(q) {
    const lq = q.toLowerCase();
    document.querySelectorAll('#livreurTable tbody tr').forEach(tr => {
        tr.style.display = tr.dataset.search.includes(lq) ? '' : 'none';
    });
}
</script>
{% endblock %}
