{% extends "client/base_client.html.twig" %}

{% block title %}Nos produits - TGV Delivery{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ asset('css/products-page.css') }}">
{% endblock %}

{% block hero %}
<div class="hero">
    <h1><i class="bi bi-bag"></i> Nos Produits</h1>
    <p>DÃ©couvrez notre sÃ©lection livrÃ©e rapidement partout en Tunisie</p>
</div>
{% endblock %}

{% block content %}

{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   BARRE FILTRES + RECHERCHE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="filter-bar">

    <div class="search-bar-wrap">
        <i class="bi bi-search"></i>
        <input type="text" id="searchInput" placeholder="Rechercher un produit...">
    </div>

    <button class="filter-pill active" id="pill-all" onclick="filterByStatus('', this)">
        Tous
    </button>
    <button class="filter-pill" id="pill-promo" onclick="filterByStatus('promo', this)">
        <i class="bi bi-tag-fill" style="color:#e84545;"></i> Offres
    </button>
    <button class="filter-pill" id="pill-disponible" onclick="filterByStatus('disponible', this)">
        <i class="bi bi-check-circle-fill" style="color:#00B37E;"></i> Disponible
    </button>
    <button class="filter-pill" id="pill-rupture" onclick="filterByStatus('rupture', this)">
        <i class="bi bi-x-circle-fill" style="color:#f59e0b;"></i> Rupture
    </button>

    <span class="results-count" id="resultsCount" style="margin-left:auto;">
        <strong id="countNum">0</strong> produit(s)
    </span>
</div>

{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CATÃ‰GORIES HORIZONTALES (icÃ´nes + titre)
   Adapte les catÃ©gories Ã  celles de ta BDD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="categories-row" id="categoriesRow">
    <button class="cat-chip active" data-cat="" onclick="filterByCategory('', this)">
        <span class="cat-chip-icon">ğŸ›’</span>
        <span class="cat-chip-label">Tout</span>
    </button>
    <button class="cat-chip" data-cat="plats principaux" onclick="filterByCategory('plats principaux', this)">
        <span class="cat-chip-icon">ğŸ½ï¸</span>
        <span class="cat-chip-label">Restauration</span>
    </button>
    <button class="cat-chip" data-cat="boissons" onclick="filterByCategory('boissons', this)">
        <span class="cat-chip-icon">ğŸ¥¤</span>
        <span class="cat-chip-label">Boissons</span>
    </button>
    <button class="cat-chip" data-cat="desserts" onclick="filterByCategory('desserts', this)">
        <span class="cat-chip-icon">ğŸ°</span>
        <span class="cat-chip-label">Desserts</span>
    </button>
    <button class="cat-chip" data-cat="snacks" onclick="filterByCategory('snacks', this)">
        <span class="cat-chip-icon">ğŸŸ</span>
        <span class="cat-chip-label">Snacks</span>
    </button>
    <button class="cat-chip" data-cat="epicerie" onclick="filterByCategory('epicerie', this)">
        <span class="cat-chip-icon">ğŸª</span>
        <span class="cat-chip-label">Ã‰picerie</span>
    </button>
    <button class="cat-chip" data-cat="pharmacie" onclick="filterByCategory('pharmacie', this)">
        <span class="cat-chip-icon">ğŸ’Š</span>
        <span class="cat-chip-label">Pharmacie</span>
    </button>
    <button class="cat-chip" data-cat="electronique" onclick="filterByCategory('electronique', this)">
        <span class="cat-chip-icon">ğŸ“±</span>
        <span class="cat-chip-label">Ã‰lectronique</span>
    </button>
    <button class="cat-chip" data-cat="beaute" onclick="filterByCategory('beaute', this)">
        <span class="cat-chip-icon">ğŸ’„</span>
        <span class="cat-chip-label">BeautÃ©</span>
    </button>
    <button class="cat-chip" data-cat="sport" onclick="filterByCategory('sport', this)">
        <span class="cat-chip-icon">âš½</span>
        <span class="cat-chip-label">Sport</span>
    </button>
    <button class="cat-chip" data-cat="maison" onclick="filterByCategory('maison', this)">
        <span class="cat-chip-icon">ğŸ </span>
        <span class="cat-chip-label">Maison</span>
    </button>
    <button class="cat-chip" data-cat="autres" onclick="filterByCategory('autres', this)">
        <span class="cat-chip-icon">ğŸ“¦</span>
        <span class="cat-chip-label">Autres</span>
    </button>
</div>

{% if produits|length > 0 %}

    {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SECTION PROMOS (produits avec rÃ©duction)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
    {% set produits_promo = [] %}
    {% for p in produits %}
        {% if p.promotion is not null and p.promotion > 0 %}
            {% set produits_promo = produits_promo|merge([p]) %}
        {% endif %}
    {% endfor %}

    {% if produits_promo|length > 0 %}
    <div id="promoSection" class="mb-5">
        <div class="section-title">
            <span class="section-tag promo">ğŸ”¥ Promos</span>
            <h2>Offres spÃ©ciales</h2>
        </div>

        <div class="products-grid" id="promoGrid">
            {% for produit in produits_promo %}
                {{ _self.product_card(produit, true) }}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SECTION TOUS LES PRODUITS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
    <div id="allProductsSection">
        <div class="section-title">
            <h2>Tous nos produits</h2>
        </div>

        <div class="products-grid" id="productsGrid">
            {% for produit in produits %}
                {{ _self.product_card(produit, false) }}
            {% endfor %}
        </div>
    </div>

{% else %}
    <div class="products-empty">
        <i class="bi bi-inbox"></i>
        <h5>Aucun produit disponible</h5>
        <p>Revenez bientÃ´t pour dÃ©couvrir nos nouveaux produits !</p>
    </div>
{% endif %}


{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MACRO â€” Carte produit
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% macro product_card(produit, forceShowDiscount) %}
    {% set hasDiscount = produit.promotion is not null and produit.promotion > 0 %}
    {% set discountPct = hasDiscount ? produit.promotion : 0 %}
    {% set prixFinal   = hasDiscount ? produit.getPrixApresPromotion() : produit.prix %}
    {% set savings     = hasDiscount ? (produit.prix - prixFinal) : 0 %}

    <div
        class="prod-card"
        data-name="{{ produit.nom|lower }}"
        data-statut="{{ produit.statut }}"
        data-category="{{ produit.categorie|lower }}"
        data-promo="{{ hasDiscount ? 'true' : 'false' }}"
    >
        <div class="prod-img-zone">
            {% if produit.image %}
                <img src="{{ asset(produit.image) }}" alt="{{ produit.nom }}">
            {% else %}
                <span class="prod-emoji">
                    {% if 'plats' in produit.categorie|lower %}ğŸ½ï¸
                    {% elseif 'dessert' in produit.categorie|lower %}ğŸ°
                    {% elseif 'boisson' in produit.categorie|lower %}ğŸ¥¤
                    {% elseif 'snack' in produit.categorie|lower %}ğŸŸ
                    {% elseif 'entree' in produit.categorie|lower or 'entrÃ©e' in produit.categorie|lower %}ğŸ¥—
                    {% else %}ğŸ›ï¸{% endif %}
                </span>
            {% endif %}

            {% if hasDiscount %}
                <span class="badge-promo">
                    <i class="bi bi-tag-fill"></i> -{{ discountPct }}%
                </span>
            {% endif %}

            {% if produit.statut == 'rupture' %}
                <span class="badge-statut rupture">Rupture</span>
            {% elseif produit.statut == 'bientot_disponible' %}
                <span class="badge-statut indispo">BientÃ´t dispo</span>
            {% endif %}
        </div>

        <div class="prod-body">
            <div class="prod-category">{{ produit.categorie }}</div>
            <div class="prod-name">{{ produit.nom }}</div>
            <div class="prod-desc">
                {{ produit.description|slice(0, 60) }}{% if produit.description|length > 60 %}...{% endif %}
            </div>

            <div class="prod-bottom">
                <div class="prod-price-block">
                    {# Prix final aprÃ¨s promo #}
                    <span class="prod-price-final">{{ prixFinal|number_format(2, ',', ' ') }} TND</span>
                    {# Prix original barrÃ© #}
                    {% if hasDiscount %}
                        <span class="prod-price-original">{{ produit.prix|number_format(2, ',', ' ') }} TND</span>
                    {% endif %}
                </div>

                {% if produit.statut == 'disponible' and produit.stock > 0 %}
                    <button
                        class="btn-add-cart"
                        onclick="addToCartFromPage(
                            {{ produit.id }},
                            '{{ produit.nom|e('js') }}',
                            {{ prixFinal }},
                            {{ produit.prix }},
                            this
                        )"
                    >
                        <i class="bi bi-cart-plus"></i> Ajouter
                    </button>
                {% else %}
                    <button class="btn-add-cart" disabled>
                        <i class="bi bi-cart-x"></i> Rupture
                    </button>
                {% endif %}
            </div>

            {% if hasDiscount %}
                <div class="prod-savings">
                    Vous Ã©conomisez {{ savings|number_format(2, ',', ' ') }} TND
                </div>
            {% endif %}
        </div>
    </div>
{% endmacro %}


<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTRE PAR CATÃ‰GORIE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeCategory = '';
let activeStatus   = '';
let searchQuery    = '';

function filterByCategory(cat, el) {
    activeCategory = cat;
    document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    applyFilters();
}

function filterByStatus(status, el) {
    activeStatus = status;
    document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
    el.classList.add('active');

    // Afficher / masquer section promos
    const promoSection = document.getElementById('promoSection');
    if (promoSection) {
        promoSection.style.display = (status === '' || status === 'promo') ? 'block' : 'none';
    }
    applyFilters();
}

function applyFilters() {
    const cards = document.querySelectorAll('#productsGrid .prod-card');
    let visible = 0;

    cards.forEach(card => {
        const name     = card.dataset.name || '';
        const statut   = card.dataset.statut || '';
        const category = card.dataset.category || '';
        const isPromo  = card.dataset.promo === 'true';

        const matchSearch   = !searchQuery || name.includes(searchQuery.toLowerCase());
        const matchCategory = !activeCategory || category.includes(activeCategory);
        const matchStatus   = !activeStatus
            || activeStatus === 'promo' ? isPromo
            : statut === activeStatus;

        const show = matchSearch && matchCategory && (
            activeStatus === ''       ? true :
            activeStatus === 'promo'  ? isPromo :
            statut === activeStatus
        );

        card.closest('.prod-card') ? (card.style.display = show ? '' : 'none') : null;
        card.style.display = show ? '' : 'none';
        if (show) visible++;
    });

    document.getElementById('countNum').textContent = visible;
}

// Recherche en temps rÃ©el
document.getElementById('searchInput').addEventListener('input', function() {
    searchQuery = this.value.trim();
    applyFilters();
});

// Init count
document.addEventListener('DOMContentLoaded', () => {
    const total = document.querySelectorAll('#productsGrid .prod-card').length;
    document.getElementById('countNum').textContent = total;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AJOUTER AU PANIER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addToCartFromPage(id, name, price, originalPrice, btn) {
    // RÃ©cupÃ¨re l'image si prÃ©sente
    const card  = btn.closest('.prod-card');
    const img   = card.querySelector('.prod-img-zone img');
    const image = img ? img.src : null;

    cart.addItem(id, name, price, originalPrice, image, 99);

    // Animation bouton
    const orig = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check-lg"></i> AjoutÃ© !';
    btn.classList.add('added');
    setTimeout(() => {
        btn.innerHTML = orig;
        btn.classList.remove('added');
    }, 1500);

    // Ouvrir le panier aprÃ¨s ajout (optionnel)
    // cartUI.open();
}
</script>


{% endblock %}
