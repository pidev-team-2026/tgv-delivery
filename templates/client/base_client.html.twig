<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>
			{% block title %}TGV Delivery - Livraison Rapide en Tunisie
			{% endblock %}
		</title>

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
		<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

		<link rel="stylesheet" href="{{ asset('css/client-navbar.css') }}">
		<link rel="stylesheet" href="{{ asset('css/client-pages.css') }}">
		<link rel="stylesheet" href="{{ asset('css/client-footer.css') }}">
		<link rel="stylesheet" href="{{ asset('css/client.css') }}">
		<link rel="stylesheet" href="{{ asset('css/client-animations.css') }}">
		<link rel="stylesheet" href="{{ asset('css/client-responsive.css') }}">
		<link rel="stylesheet" href="{{ asset('css/base-client.css') }}">
		<link rel="stylesheet" href="{{ asset('css/cart-panel.css') }}"> {% block styles %}{% endblock %}


    </head>

<body>

	<!-- NAVBAR -->
	<nav class="navbar-modern">
		<div class="container-fluid">
			<a class="brand" href="{{ path('client_') }}">
				<img src="{{ asset('images/logo.png') }}" alt="TGV Delivery">
			</a>
			<ul class="nav-menu">
				<li class="nav-item">
					<a href="{{ path('client_') }}" class="nav-link">
						<i class="bi bi-house-door"></i>
						<span>Accueil</span>
					</a>
				</li>
				<li class="nav-item dropdown-item">
					<a href="#" class="nav-link">
						<i class="bi bi-shop"></i>
						<span>Shop</span>
						<i class="bi bi-chevron-down arrow"></i>
					</a>
					<div class="dropdown-menu">
						<a href="{{ path('client_produits') }}" class="dropdown-link">
							<i class="bi bi-bag"></i>
							<span>Produits</span>
						</a>
						<a href="{{ path('client_commandes') }}" class="dropdown-link">
							<i class="bi bi-clipboard-check"></i>
							<span>Mes Commandes</span>
						</a>
					</div>
				</li>
				<li class="nav-item dropdown-item">
					<a href="#" class="nav-link">
						<i class="bi bi-tools"></i>
						<span>Services</span>
						<i class="bi bi-chevron-down arrow"></i>
					</a>
					<div class="dropdown-menu">
						<a href="{{ path('client_services') }}" class="dropdown-link">
							<i class="bi bi-gear"></i>
							<span>Nos Services</span>
						</a>
						<a href="{{ path('client_services') }}#express" class="dropdown-link">
							<i class="bi bi-lightning"></i>
							<span>Livraison Express</span>
						</a>
					</div>
				</li>
				<li class="nav-item dropdown-item">
					<a href="#" class="nav-link">
						<i class="bi bi-headset"></i>
						<span>Support</span>
						<i class="bi bi-chevron-down arrow"></i>
					</a>
					<div class="dropdown-menu">
						<a href="{{ path('client_reclamations') }}" class="dropdown-link">
							<i class="bi bi-exclamation-circle"></i>
							<span>R√©clamations</span>
						</a>
						<a href="{{ path('client_support') }}" class="dropdown-link">
							<i class="bi bi-chat-dots"></i>
							<span>Contactez-nous</span>
						</a>
					</div>
				</li>
				<li class="nav-item">
					<a href="{{ path('client_partenaires') }}" class="nav-link">
						<i class="bi bi-people"></i>
						<span>Partenaires</span>
					</a>
				</li>
			</ul>
			<div class="nav-actions">
				<div class="cart-icon" id="cartIconBtn" style="font-size:1.4rem;color:#333;">
					<i class="bi bi-cart3"></i>
					<span class="cart-badge" id="cartNavBadge">0</span>
				</div>
				<a href="" class="btn-auth btn-login">
					<i class="bi bi-box-arrow-in-right"></i>
					<span>Connexion</span>
				</a>
				<a href="" class="btn-auth btn-register">
					<i class="bi bi-person-plus"></i>
					<span>S'inscrire</span>
				</a>
			</div>
			<button class="mobile-toggle" id="mobileToggle">
				<span></span>
				<span></span>
				<span></span>
			</button>
		</div>
	</nav>

	{% if app.flashes %}
		<div class="container mt-3">
			{% for type, messages in app.flashes %}
				{% for message in messages %}
					<div class="alert alert-{{ type }} alert-dismissible fade show" role="alert">
						{{ message }}
						<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
					</div>
				{% endfor %}
			{% endfor %}
		</div>
	{% endif %}

	<main class="main-content"> {% block hero %}{% endblock %}
		<div class="container py-4"> {% block content %}{% endblock %}
			</div>
		</main>

		<footer class="footer-modern">
			<div class="container">
				<div class="row">
					<div class="col-md-4 mb-4">
						<h5>
							<i class="bi bi-truck"></i>
							<h5>TGV Delivery</h5>
							<p>
								Votre partenaire de confiance pour des livraisons rapides, s√©curis√©es et efficaces
								    partout en Tunisie.
							</p>
							<div class="social-links">
								<a href="#">
									<i class="bi bi-facebook"></i>
								</a>
								<a href="#">
									<i class="bi bi-twitter"></i>
								</a>
								<a href="#">
									<i class="bi bi-instagram"></i>
								</a>
								<a href="#">
									<i class="bi bi-linkedin"></i>
								</a>
							</div>
						</div>
						<div class="col-md-2 mb-4">
							<h5>Shop</h5>
							<ul class="footer-links">
								<li>
									<a href="{{ path('client_produits') }}">Produits</a>
								</li>
								<li>
									<a href="{{ path('client_commandes') }}">Mes Commandes</a>
								</li>
							</ul>
						</div>
						<div class="col-md-2 mb-4">
							<h5>Services</h5>
							<ul class="footer-links">
								<li>
									<a href="{{ path('client_services') }}">Nos Services</a>
								</li>
								<li>
									<a href="#">Livraison Express</a>
								</li>
							</ul>
						</div>
						<div class="col-md-2 mb-4">
							<h5>Support</h5>
							<ul class="footer-links">
								<li>
									<a href="{{ path('client_reclamations') }}">R√©clamations</a>
								</li>
								<li>
									<a href="{{ path('client_support') }}">Contact</a>
								</li>
							</ul>
						</div>
						<div class="col-md-2 mb-4">
							<h5>Contact</h5>
							<ul class="footer-contact">
								<li>
									<i class="bi bi-telephone"></i>
									+216 71 000 000</li>
								<li>
									<i class="bi bi-envelope"></i>
									contact@tgv.tn</li>
								<li>
									<i class="bi bi-geo-alt"></i>
									Tunis, Tunisie</li>
							</ul>
						</div>
					</div>
					<div class="footer-bottom">
						<p>&copy; 2026 TGV Delivery ‚Äî Tous droits r√©serv√©s</p>
					</div>
				</div>
			</footer>

			<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
					     PANNEAU PANIER
					‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
			<div class="cart-overlay" id="cartOverlay"></div>

			<div class="cart-panel" id="cartPanel">
				<div class="cart-panel-header">
					<div class="cart-panel-title">
						<i class="bi bi-cart3"></i>
						Mon Panier
						<span class="cart-count-badge" id="cartPanelCount">0</span>
					</div>
					<button class="cart-panel-close" onclick="cartUI.close()">
						<i class="bi bi-x-lg"></i>
					</button>
				</div>

				<!-- VUE PANIER -->
				<div id="cartViewCart" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
					<div class="cart-panel-body" id="cartPanelBody">
						<div class="cart-empty-state" id="cartEmpty">
							<i class="bi bi-cart-x"></i>
							<h6>Votre panier est actuellement vide</h6>
							<p>D√©couvrez nos produits et commencez vos achats d√®s maintenant.</p>
						</div>
						<div id="cartItemsList"></div>
					</div>
					<div class="cart-panel-footer" id="cartPanelFooter" style="display:none;">
						<button class="cart-clear-btn" onclick="cart.clearCart()">
							<i class="bi bi-trash3"></i>
							Vider le panier
						</button>
						<div class="cart-totals">
							<div class="cart-total-row">
								<span>Sous-total</span>
								<span id="cartSubtotal">0,000 TND</span>
							</div>
							<div class="cart-total-row" id="cartRemiseLine" style="display:none;color:#00B37E;font-weight:600;">
								<span>
									<i class="bi bi-tag-fill"></i>
									Remise promo</span>
								<span id="cartRemiseVal">‚àí0,000 TND</span>
							</div>
							<div class="cart-total-row">
								<span>
									<i class="bi bi-truck"></i>
									Livraison</span>
								<span id="cartLivraison">7,000 TND</span>
							</div>
							<div class="cart-total-row main-total">
								<span>TOTAL</span>
								<span id="cartTotal">0,000 TND</span>
							</div>
						</div>
						<button class="btn-passer-commande" onclick="cartUI.goToCheckout()">
							<i class="bi bi-bag-check"></i>
							Passer la commande
						</button>
					</div>
				</div>

				<!-- VUE CHECKOUT -->
				<div id="cartViewCheckout" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
					<div class="cart-panel-body">
						<button class="btn-back" onclick="cartUI.backToCart()">
							<i class="bi bi-arrow-left"></i>
							Retour au panier
						</button>

						<!-- onsubmit ‚Üí intercept√© par handleCheckoutSubmit -->
						<form
							id="checkoutForm" onsubmit="handleCheckoutSubmit(event)">

							<!-- √âTAPE 1 -->
							<div class="checkout-step">
								<div class="checkout-step-num">1</div>
								<div class="checkout-step-content">
									<div class="checkout-step-title">
										<i class="bi bi-person"></i>
										Informations personnelles</div>
									<div class="checkout-field">
										<label class="checkout-label">Pr√©nom & Nom</label>
										<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
											<input class="checkout-input" type="text" name="prenom" placeholder="Mohamed" required>
											<input class="checkout-input" type="text" name="nom" placeholder="Ben Ali" required>
										</div>
									</div>
									<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
										<div class="checkout-field">
											<label class="checkout-label">Email</label>
											<input class="checkout-input" type="email" name="email" placeholder="email@tgv.tn" required>
										</div>
										<div class="checkout-field">
											<label class="checkout-label">T√©l√©phone</label>
											<input class="checkout-input" type="tel" name="telephone" placeholder="+216 55 000 000" required>
										</div>
									</div>
								</div>
							</div>

							<!-- √âTAPE 2 -->
							<div class="checkout-step">
								<div class="checkout-step-num">2</div>
								<div class="checkout-step-content">
									<div class="checkout-step-title">
										<i class="bi bi-geo-alt"></i>
										Adresse de livraison</div>
									<div class="checkout-field">
										<label class="checkout-label">Gouvernorat</label>
										<div class="gouvernorat-wrapper">
											<input class="gouvernorat-input" id="govInput" name="gouvernorat" type="text" placeholder="Rechercher votre gouvernorat..." autocomplete="off" required>
											<div class="gouvernorat-list" id="govList"></div>
										</div>
										<div class="estimation-box" id="estimationLivraison">
											<i class="bi bi-clock"></i>
											<span id="estimationText"></span>
										</div>
									</div>
									<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
										<div class="checkout-field">
											<label class="checkout-label">Ville / D√©l√©gation</label>
											<input class="checkout-input" type="text" name="ville" placeholder="La Marsa" required>
										</div>
										<div class="checkout-field">
											<label class="checkout-label">Code postal</label>
											<input class="checkout-input" type="text" name="codePostal" placeholder="1000" maxlength="4" required>
										</div>
									</div>
									<div class="checkout-field">
										<label class="checkout-label">Adresse compl√®te</label>
										<input class="checkout-input" type="text" name="adresse" placeholder="N¬∞ rue, nom rue, quartier..." required>
									</div>
								</div>
							</div>

							<!-- √âTAPE 3 -->
							<div class="checkout-step">
								<div class="checkout-step-num">3</div>
								<div class="checkout-step-content">
									<div class="checkout-step-title">
										<i class="bi bi-tag"></i>
										Code promo</div>
									<div class="promo-wrap">
										<div class="promo-wrap-title">
											<i class="bi bi-gift"></i>
											Vous avez un code ?</div>
										<div class="promo-input-row">
											<input type="text" id="promoInput" placeholder="Ex: TGV10, LIVFREE..." maxlength="20">
											<button type="button" class="promo-apply-btn" id="promoBtn" onclick="appliquerPromo()">Appliquer</button>
										</div>
										<div class="promo-msg" id="promoMsg"></div>
										<div class="promo-hint">Codes dispo : TGV10 ¬∑ TGV20 ¬∑ LIVFREE ¬∑ BIENVENUE</div>
									</div>
								</div>
							</div>

							<!-- √âTAPE 4 -->
							<div class="checkout-step">
								<div class="checkout-step-num">4</div>
								<div class="checkout-step-content">
									<div class="checkout-step-title">
										<i class="bi bi-credit-card"></i>
										Mode de paiement</div>
									<div class="payment-opts">
										<label class="payment-opt selected" onclick="selectPayment(this)">
											<input type="radio" name="paiement" value="carte" checked>
											<i class="bi bi-credit-card-2-front"></i>
											<div>
												<div style="font-weight:600;font-size:0.85rem;">Carte bancaire</div>
												<div style="font-size:0.75rem;color:#aaa;">Visa, Mastercard, CIB</div>
											</div>
											<span class="payment-opt-check">
												<i class="bi bi-check"></i>
											</span>
										</label>
										<label class="payment-opt" onclick="selectPayment(this)">
											<input type="radio" name="paiement" value="virement">
											<i class="bi bi-bank"></i>
											<div>
												<div style="font-weight:600;font-size:0.85rem;">Virement bancaire</div>
												<div style="font-size:0.75rem;color:#aaa;">STB, BNA, BIAT...</div>
											</div>
											<span class="payment-opt-check"></span>
										</label>
										<label class="payment-opt" onclick="selectPayment(this)">
											<input type="radio" name="paiement" value="especes">
											<i class="bi bi-cash-stack"></i>
											<div>
												<div style="font-weight:600;font-size:0.85rem;">Paiement √† la livraison</div>
												<div style="font-size:0.75rem;color:#aaa;">Esp√®ces √† la r√©ception</div>
											</div>
											<span class="payment-opt-check"></span>
										</label>
									</div>
								</div>
							</div>

							<!-- R√©sum√© -->
							<div style="background:#f9fafb;border-radius:12px;padding:14px 16px;margin:8px 0 16px;">
								<div style="display:flex;justify-content:space-between;font-size:0.85rem;color:#555;margin-bottom:6px;">
									<span>Sous-total</span>
									<span id="ckSubtotal">0,000 TND</span>
								</div>
								<div id="ckRemiseLine" style="display:none;justify-content:space-between;font-size:0.85rem;color:#00B37E;font-weight:600;margin-bottom:6px;">
									<span>
										<i class="bi bi-tag-fill"></i>
										Remise</span>
									<span id="ckRemise">0,000 TND</span>
								</div>
								<div style="display:flex;justify-content:space-between;font-size:0.85rem;color:#555;margin-bottom:6px;">
									<span>
										<i class="bi bi-truck"></i>
										Livraison</span>
									<span id="ckLivraison">7,000 TND</span>
								</div>
								<div style="display:flex;justify-content:space-between;font-family:'Syne',sans-serif;font-weight:800;font-size:1rem;border-top:1px solid #e8e8e8;padding-top:10px;margin-top:4px;">
									<span>TOTAL</span>
									<span style="color:#00B37E;" id="ckTotal">0,000 TND</span>
								</div>
							</div>

							<button type="submit" class="btn-valider">
								<i class="bi bi-check-circle-fill"></i>
								Valider la commande
							</button>
						</form>
					</div>
				</div>
			</div>

			<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
					     MODAL ‚Äî CARTE BANCAIRE
					‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
			<div class="pay-overlay" id="modalCarte">
				<div class="pay-modal">
					<div class="pay-modal-head">
						<div class="pay-modal-ico c">
							<i class="bi bi-credit-card-2-front"></i>
						</div>
						<div class="pay-modal-head-txt">
							<h5>Carte bancaire</h5>
							<p>√âtape 4/5 ‚Äî Paiement s√©curis√©</p>
						</div>
						<button class="pay-modal-x" onclick="closePayModal('modalCarte')">
							<i class="bi bi-x"></i>
						</button>
					</div>
					<div class="pay-modal-body">
						<div class="pf">
							<label class="pl">Nom sur la carte</label>
							<input class="pi" type="text" id="cardName" placeholder="Ex: Ahmed Ben Ali">
						</div>
						<div class="pf">
							<label class="pl">Num√©ro de carte</label>
							<div class="card-num-wrap">
								<input class="pi" type="text" id="cardNumber" placeholder="0000 0000 0000 0000" maxlength="19" oninput="formatCardNum(this)" style="padding-right:44px;">
								<span class="card-brand" id="cardBrand">
									<i class="bi bi-credit-card"></i>
								</span>
							</div>
						</div>
						<div class="pi-row">
							<div class="pf">
								<label class="pl">Date d'expiration</label>
								<input class="pi" type="text" id="cardExp" placeholder="MM/AA" maxlength="5" oninput="formatExp(this)">
							</div>
							<div class="pf">
								<label class="pl">CVV</label>
								<input class="pi" type="text" id="cardCvv" placeholder="123" maxlength="3" style="letter-spacing:4px;">
							</div>
						</div>
						<div class="pay-secure">
							<i class="bi bi-shield-check-fill"></i>
							Paiement s√©curis√© SSL ‚Äî donn√©es jamais stock√©es
						</div>
						<button class="btn-confirm green" id="btnConfirmCarte" onclick="confirmerCarte()">
							<i class="bi bi-lock-fill"></i>
							Confirmer le paiement
						</button>
					</div>
				</div>
			</div>

			<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
					     MODAL ‚Äî VIREMENT BANCAIRE
					‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
			<div class="pay-overlay" id="modalVirement">
				<div class="pay-modal">
					<div class="pay-modal-head">
						<div class="pay-modal-ico v">
							<i class="bi bi-bank"></i>
						</div>
						<div class="pay-modal-head-txt">
							<h5>Virement bancaire</h5>
							<p>√âtape 4/5 ‚Äî Effectuez le virement ci-dessous</p>
						</div>
						<button class="pay-modal-x" onclick="closePayModal('modalVirement')">
							<i class="bi bi-x"></i>
						</button>
					</div>
					<div class="pay-modal-body">
						<p style="font-size:0.84rem;color:#666;margin-bottom:14px;">
							Votre commande sera trait√©e d√®s r√©ception du virement. Utilisez votre r√©f√©rence commande en objet.
						</p>
						<div class="vir-box">
							<div class="vir-row">
								<div class="vir-row-txt">
									<div class="vir-lbl">Banque</div>
									<div class="vir-val">STB ‚Äî Soci√©t√© Tunisienne de Banque</div>
								</div>
								<button class="copy-btn" onclick="copyTxt('STB ‚Äî Soci√©t√© Tunisienne de Banque')" title="Copier">
									<i class="bi bi-clipboard"></i>
								</button>
							</div>
							<div class="vir-row">
								<div class="vir-row-txt">
									<div class="vir-lbl">Titulaire</div>
									<div class="vir-val">SARL TGV Delivery Tunisia</div>
								</div>
								<button class="copy-btn" onclick="copyTxt('SARL TGV Delivery Tunisia')" title="Copier">
									<i class="bi bi-clipboard"></i>
								</button>
							</div>
							<div class="vir-row">
								<div class="vir-row-txt">
									<div class="vir-lbl">RIB</div>
									<div class="vir-val">10 006 0350000123456 78</div>
								</div>
								<button class="copy-btn" onclick="copyTxt('10 006 0350000123456 78')" title="Copier">
									<i class="bi bi-clipboard"></i>
								</button>
							</div>
							<div class="vir-row">
								<div class="vir-row-txt">
									<div class="vir-lbl">IBAN</div>
									<div class="vir-val">TN59 1000 6035 0000 1234 5678</div>
								</div>
								<button class="copy-btn" onclick="copyTxt('TN59 1000 6035 0000 1234 5678')" title="Copier">
									<i class="bi bi-clipboard"></i>
								</button>
							</div>
							<div class="vir-row">
								<div class="vir-row-txt">
									<div class="vir-lbl">Code SWIFT</div>
									<div class="vir-val">STBKTNTT</div>
								</div>
								<button class="copy-btn" onclick="copyTxt('STBKTNTT')" title="Copier">
									<i class="bi bi-clipboard"></i>
								</button>
							</div>
						</div>
						<div class="vir-ref-alert">
							<i class="bi bi-info-circle-fill"></i>
							Mentionnez votre num√©ro de commande
							<strong id="virRefNum">‚Äî</strong>
							en r√©f√©rence.
						</div>
						<button class="btn-confirm blue" onclick="confirmerVirement()">
							<i class="bi bi-check-circle-fill"></i>
							J'ai effectu√© le virement
						</button>
					</div>
				</div>
			</div>

			<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
					     MODAL ‚Äî ESP√àCES √Ä LA LIVRAISON
					‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
			<div class="pay-overlay" id="modalEspeces">
				<div class="pay-modal">
					<div class="pay-modal-head">
						<div class="pay-modal-ico e">
							<i class="bi bi-cash-stack"></i>
						</div>
						<div class="pay-modal-head-txt">
							<h5>Paiement √† la livraison</h5>
							<p>√âtape 4/5 ‚Äî Esp√®ces √† la r√©ception</p>
						</div>
						<button class="pay-modal-x" onclick="closePayModal('modalEspeces')">
							<i class="bi bi-x"></i>
						</button>
					</div>
					<div class="pay-modal-body">
						<p style="font-size:0.84rem;color:#666;margin-bottom:14px;">
							Payez en esp√®ces √† la r√©ception. Pr√©parez le montant exact si possible.
						</p>
						<div class="esp-box">
							<div class="esp-row">
								<i class="bi bi-geo-alt-fill"></i>
								<div>
									<div class="esp-lbl">Adresse de livraison</div>
									<div class="esp-val" id="espAdresse">‚Äî</div>
								</div>
							</div>
							<div class="esp-row">
								<i class="bi bi-telephone-fill"></i>
								<div>
									<div class="esp-lbl">Num√©ro de contact</div>
									<div class="esp-val" id="espTel">‚Äî</div>
								</div>
							</div>
							<div class="esp-row">
								<i class="bi bi-clock-fill"></i>
								<div>
									<div class="esp-lbl">D√©lai estim√©</div>
									<div class="esp-val" id="espDelai">Livraison sous 24‚Äì48h</div>
								</div>
							</div>
							<div class="esp-row">
								<i class="bi bi-cash-coin"></i>
								<div>
									<div class="esp-lbl">Montant total √† pr√©parer</div>
									<div class="esp-val" style="color:#00B37E;font-size:1.05rem;" id="espTotal">‚Äî</div>
								</div>
							</div>
						</div>
						<div class="esp-warn">
							<i class="bi bi-exclamation-triangle-fill"></i>
							Frais de livraison de
							<strong id="espFrais">7,000 TND</strong>
							inclus dans le total.
						</div>
						<button class="btn-confirm yellow" onclick="confirmerEspeces()">
							<i class="bi bi-check-circle-fill"></i>
							Confirmer la commande
						</button>
					</div>
				</div>
			</div>

			<!-- TOAST -->
			<div class="tgv-toast" id="tgvToast">
				<i class="bi bi-check-circle-fill" style="color:#00B37E;"></i>
				<span id="tgvToastMsg"></span>
			</div>

			<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
			<script src="{{ asset('js/cart.js') }}"></script>
			<script src="{{ asset('js/navbar.js') }}"></script>

			<script>
				// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYST√àME PAIEMENT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _pendingData = null;
// donn√©es commande en attente

// ‚îÄ‚îÄ Fermer modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closePayModal(id) {
if (id) {
document.getElementById(id).classList.remove('open');
} else {
document.querySelectorAll('.pay-overlay').forEach(m => m.classList.remove('open'));
}
// R√©activer le bouton valider
const btn = document.querySelector('.btn-valider');
if (btn) {
btn.disabled = false;
btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Valider la commande';
}
}

// Fermer en cliquant hors de la modal
document.querySelectorAll('.pay-overlay').forEach(overlay => {
overlay.addEventListener('click', function (e) {
if (e.target === this) 
closePayModal(this.id);


});
});

// ‚îÄ‚îÄ Ouvrir selon m√©thode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openPayModal(methode, data) {
_pendingData = data;
const t = cart.getTotals();
const fmt = v => parseFloat(v).toFixed(3).replace('.', ',') + ' TND';

document.querySelectorAll('.pay-overlay').forEach(m => m.classList.remove('open'));

if (methode === 'carte') {
document.getElementById('modalCarte').classList.add('open');

} else if (methode === 'virement') { // R√©f√©rence provisoire jusqu'√† enregistrement
document.getElementById('virRefNum').textContent = 'CMD-' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '-XXXXXX';
document.getElementById('modalVirement').classList.add('open');

} else { // Esp√®ces
document.getElementById('espAdresse').textContent = (data.adresse || '‚Äî') + ', ' + (
data.ville || ''
) + ' ' + (
data.codePostal || ''
);
document.getElementById('espTel').textContent = data.telephone || '‚Äî';

// Estimation livraison
const estTxt = document.getElementById('estimationText');
if (estTxt && estTxt.textContent) {
document.getElementById('espDelai').textContent = estTxt.textContent;
}

document.getElementById('espFrais').textContent = fmt(t.livraison);
document.getElementById('espTotal').textContent = fmt(t.total);
document.getElementById('modalEspeces').classList.add('open');
}
}

// ‚îÄ‚îÄ Intercepter le submit du form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleCheckoutSubmit(e) {
e.preventDefault();

const form = document.getElementById('checkoutForm');
const data = Object.fromEntries(new FormData(form).entries());

// Validation
if (! data.prenom || ! data.nom || ! data.email || ! data.telephone || ! data.gouvernorat || ! data.adresse || ! data.ville || ! data.codePostal) {
showToast('‚ùå Veuillez remplir tous les champs obligatoires.');
return;
}

// Enrichir avec panier + promo
data.items = cart.getItems();
data.remise = window.promoActif ? window.promoActif.remise : 0;
data.fraisLivraison = window.promoActif ? window.promoActif.fraisLivraison : 7.0;
data.codePromo = window.promoActif ? window.promoActif.code : null;

if (! data.items || data.items.length === 0) {
showToast('‚ùå Votre panier est vide.');
return;
}

// D√©sactiver bouton
const btn = form.querySelector('.btn-valider');
btn.disabled = true;
btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Traitement...';

// Ouvrir la bonne modal
openPayModal(data.paiement || 'especes', data);
}

// ‚îÄ‚îÄ CONFIRMER CARTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmerCarte() {
const name = document.getElementById('cardName').value.trim();
const number = document.getElementById('cardNumber').value.replace(/\s/g, '');
const exp = document.getElementById('cardExp').value.trim();
const cvv = document.getElementById('cardCvv').value.trim();

if (! name) {
showToast('‚ùå Entrez le nom sur la carte.');
return;
}
if (number.length < 16) {
showToast('‚ùå Num√©ro de carte incomplet.');
return;
}
if (! exp.match(/^\d{2}\/\d{2}$/)) {
showToast('‚ùå Date d\'expiration invalide (MM/AA).');
return;
}
if (cvv.length < 3) {
showToast('‚ùå CVV invalide.');
return;
}

const btn = document.getElementById('btnConfirmCarte');
btn.disabled = true;
btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Enregistrement...';

closePayModal('modalCarte');
enregistrerCommande(_pendingData);
}

// ‚îÄ‚îÄ CONFIRMER VIREMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmerVirement() {
closePayModal('modalVirement');
enregistrerCommande(_pendingData);
}

// ‚îÄ‚îÄ CONFIRMER ESP√àCES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmerEspeces() {
closePayModal('modalEspeces');
enregistrerCommande(_pendingData);
}

// ‚îÄ‚îÄ ENREGISTRER EN BDD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function enregistrerCommande(data) {
showToast('‚è≥ Enregistrement en cours...');

fetch('/commande/api/client/commande', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'X-Requested-With': 'XMLHttpRequest'
},
body: JSON.stringify(data)
}).then(r => r.json()).then(res => {
if (res.success) { // Mettre √† jour r√©f√©rence virement si besoin
const virRef = document.getElementById('virRefNum');
if (virRef) 
virRef.textContent = res.reference;



cart.clearCart();
cartUI.close();
showToast('‚úÖ Commande ' + res.reference + ' enregistr√©e !');
setTimeout(() => window.location.href = '/client/commandes', 2800);
} else {
showToast('‚ùå Erreur : ' + (
res.message || 'R√©essayez.'
));
const btn = document.querySelector('.btn-valider');
if (btn) {
btn.disabled = false;
btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Valider la commande';
}
}
}).catch(() => {
showToast('‚ùå Erreur de connexion.');
const btn = document.querySelector('.btn-valider');
if (btn) {
btn.disabled = false;
btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Valider la commande';
}
});
}

// ‚îÄ‚îÄ Formatage carte ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatCardNum(input) {
let v = input.value.replace(/\D/g, '').substring(0, 16);
input.value = v.replace(/(.{4})/g, '$1 ').trim();
const brand = document.getElementById('cardBrand');
if (v.startsWith('4')) 
brand.innerHTML = '<i class="bi bi-credit-card" style="color:#1a1aff"></i>';
 else if (v.startsWith('5')) 
brand.innerHTML = '<i class="bi bi-credit-card" style="color:#eb001b"></i>';
 else 
brand.innerHTML = '<i class="bi bi-credit-card"></i>';


}

function formatExp(input) {
let v = input.value.replace(/\D/g, '').substring(0, 4);
if (v.length >= 2) 
v = v.substring(0, 2) + '/' + v.substring(2);


input.value = v;
}

// ‚îÄ‚îÄ Copier ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyTxt(text) {
navigator.clipboard.writeText(text).then(() => showToast('üìã Copi√© !'));
}
			</script>
		</body>
	</body>
</html>
