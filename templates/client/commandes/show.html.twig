{% extends "client/base_client.html.twig" %}

{% block title %}Commande {{ commande.reference }} ‚Äî TGV Delivery{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ asset('css/commande-detailes.css') }}">
{% endblock %}

{% block hero %}
<div class="hero">
    <h1><i class="bi bi-receipt"></i> D√©tails de la commande</h1>
    <p>R√©f√©rence : <strong>{{ commande.reference }}</strong></p>
</div>
{% endblock %}

{% block content %}

{# ‚îÄ‚îÄ Parser items depuis notes JSON ‚îÄ‚îÄ #}
{% set items = [] %}
{% if commande.notes %}
    {% set parsed = commande.notes|json_encode %}
    {% if parsed is iterable %}{% set items = parsed %}{% endif %}
{% endif %}

{# ‚îÄ‚îÄ Index du statut pour le suivi ‚îÄ‚îÄ #}
{% set statutOrder = ['en_attente','confirmee','en_preparation','prete','en_livraison','livree'] %}
{% set currentIdx = 0 %}
{% for i, s in statutOrder %}
    {% if s == commande.statut %}{% set currentIdx = i %}{% endif %}
{% endfor %}

<div class="cmd-page">

    <!-- HEADER -->
    <div class="cmd-header">
        <div class="cmd-ref">Commande <span>#{{ commande.reference }}</span></div>
        <a href="{{ path('client_commandes') }}" class="btn-back-cmd">
            <i class="bi bi-arrow-left"></i> Mes commandes
        </a>
    </div>

    <!-- BADGE STATUT -->
    <div class="s-badge s-{{ commande.statut }}">
        {% if commande.statut == 'en_attente' %}<i class="bi bi-hourglass-split"></i> En attente de validation
        {% elseif commande.statut == 'confirmee' %}<i class="bi bi-check-circle-fill"></i> Confirm√©e
        {% elseif commande.statut == 'en_preparation' %}<i class="bi bi-box-seam"></i> En pr√©paration
        {% elseif commande.statut == 'prete' %}<i class="bi bi-bag-check-fill"></i> Pr√™te √† exp√©dier
        {% elseif commande.statut == 'en_livraison' %}<i class="bi bi-truck"></i> En cours de livraison
        {% elseif commande.statut == 'livree' %}<i class="bi bi-check2-circle"></i> Livr√©e ‚úì
        {% elseif commande.statut == 'annulee' %}<i class="bi bi-x-circle-fill"></i> Annul√©e
        {% else %}{{ commande.statut }}{% endif %}
    </div>

    <div class="cmd-grid">

        <!-- ‚ïê‚ïê‚ïê COLONNE GAUCHE ‚ïê‚ïê‚ïê -->
        <div>

            <!-- R√âSUM√â COMMANDE -->
            <div class="cc">
                <div class="cc-head"><i class="bi bi-receipt"></i> R√©sum√© de la commande</div>
                <div class="cc-body">
                    <div class="ir">
                        <span class="ir-l">R√©f√©rence</span>
                        <span class="ir-v" style="font-family:monospace;">{{ commande.reference }}</span>
                    </div>
                    <div class="ir">
                        <span class="ir-l">Date</span>
                        <span class="ir-v">{{ commande.dateCreation ? commande.dateCreation|date('d/m/Y √† H:i') : '‚Äî' }}</span>
                    </div>
                    <div class="ir">
                        <span class="ir-l">Client</span>
                        <span class="ir-v">{{ commande.nomClient }}</span>
                    </div>
                    <div class="ir">
                        <span class="ir-l">Email</span>
                        <span class="ir-v">{{ commande.email ?? '‚Äî' }}</span>
                    </div>
                    <div class="ir">
                        <span class="ir-l">T√©l√©phone</span>
                        <span class="ir-v">{{ commande.telephone }}</span>
                    </div>
                    <div class="ir">
                        <span class="ir-l">Paiement</span>
                        <span class="ir-v">
                            {% if commande.modePaiement == 'carte' %}
                                <span class="pay-b"><i class="bi bi-credit-card-2-front"></i> Carte bancaire</span>
                            {% elseif commande.modePaiement == 'virement' %}
                                <span class="pay-b"><i class="bi bi-bank"></i> Virement bancaire</span>
                            {% else %}
                                <span class="pay-b"><i class="bi bi-cash-stack"></i> Paiement √† la livraison</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if commande.codePromo %}
                    <div class="ir">
                        <span class="ir-l">Code promo</span>
                        <span class="ir-v" style="color:#00B37E;"><i class="bi bi-tag-fill"></i> {{ commande.codePromo }}</span>
                    </div>
                    {% endif %}
                    <div class="ir">
                        <span class="ir-l"><i class="bi bi-truck"></i> Frais livraison</span>
                        <span class="ir-v">{{ commande.fraisLivraison|number_format(3,',','') }} TND</span>
                    </div>
                </div>

                {% if commande.remise is defined and commande.remise > 0 %}
                <div class="remise-band">
                    <span><i class="bi bi-tag-fill"></i> Remise appliqu√©e</span>
                    <span>‚àí{{ commande.remise|number_format(3,',','') }} TND</span>
                </div>
                {% endif %}

                <div class="total-band">
                    <span class="total-band-l">TOTAL TTC</span>
                    <span class="total-band-v">
                        {{ (commande.totalPrix + commande.fraisLivraison)|number_format(3,',','') }} TND
                    </span>
                </div>
            </div>

            <!-- ARTICLES -->
            <div class="cc">
                <div class="cc-head">
                    <i class="bi bi-bag"></i> Articles command√©s
                    <span style="margin-left:auto;font-size:0.78rem;color:#bbb;font-weight:400;">{{ items|length }} article(s)</span>
                </div>
                <div class="cc-body">
                    {% if items|length > 0 %}
                        {% for item in items %}
                        <div class="item-row">
                            <div class="item-thumb">
                                {% if item.image is defined and item.image %}
                                    <img src="{{ item.image }}" alt="{{ item.name }}">
                                {% else %}üõçÔ∏è{% endif %}
                            </div>
                            <div>
                                <div class="item-n">{{ item.name ?? item.nom ?? 'Produit' }}</div>
                                <div class="item-q">Quantit√© : {{ item.qty ?? item.quantite ?? 1 }}</div>
                            </div>
                            <div class="item-p">
                                {{ ((item.price ?? item.prix ?? 0) * (item.qty ?? item.quantite ?? 1))|number_format(3,',','') }} TND
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="color:#ccc;text-align:center;font-size:0.84rem;padding:14px 0;">
                            D√©tail des articles non disponible.
                        </p>
                    {% endif %}

                    <!-- Sous-totaux -->
                    <div style="border-top:2px solid #f0f0f0;margin-top:14px;padding-top:14px;">
                        <div class="ir">
                            <span class="ir-l">Sous-total produits</span>
                            <span class="ir-v">{{ commande.totalPrix|number_format(3,',','') }} TND</span>
                        </div>
                        <div class="ir">
                            <span class="ir-l"><i class="bi bi-truck"></i> Livraison</span>
                            <span class="ir-v">{{ commande.fraisLivraison|number_format(3,',','') }} TND</span>
                        </div>
                        {% if commande.remise is defined and commande.remise > 0 %}
                        <div class="ir" style="color:#00B37E;">
                            <span class="ir-l" style="color:#00B37E;"><i class="bi bi-tag-fill"></i> Remise</span>
                            <span class="ir-v" style="color:#00B37E;">‚àí{{ commande.remise|number_format(3,',','') }} TND</span>
                        </div>
                        {% endif %}
                        <div class="ir">
                            <span class="ir-l" style="font-family:'Syne',sans-serif;font-weight:800;color:#1a1a1a;font-size:0.95rem;">TOTAL</span>
                            <span class="ir-v" style="color:#00B37E;font-size:1.1rem;font-family:'Syne',sans-serif;font-weight:800;">
                                {{ (commande.totalPrix + commande.fraisLivraison)|number_format(3,',','') }} TND
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOUTON ANNULER (seulement si en_attente) -->
            {% if commande.statut == 'en_attente' %}
            <div class="cc">
                <div class="cc-body" style="text-align:center;">
                    <p style="font-size:0.82rem;color:#bbb;margin-bottom:14px;">
                        Vous pouvez annuler votre commande tant qu'elle est en attente de validation.
                    </p>
                    <button class="btn-annuler" onclick="openAnnul()">
                        <i class="bi bi-x-circle-fill"></i> Annuler cette commande
                    </button>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- ‚ïê‚ïê‚ïê COLONNE DROITE ‚ïê‚ïê‚ïê -->
        <div>

            <!-- ADRESSE LIVRAISON (vraies donn√©es BDD) -->
            <div class="cc">
                <div class="cc-head"><i class="bi bi-geo-alt-fill"></i> Livraison</div>
                <div class="cc-body">
                    {% if commande.gouvernorat is defined and commande.gouvernorat %}
                    <div class="ir">
                        <span class="ir-l">Gouvernorat</span>
                        <span class="ir-v">{{ commande.gouvernorat }}</span>
                    </div>
                    {% endif %}
                    <div class="ir">
                        <span class="ir-l">Ville</span>
                        <span class="ir-v">{{ commande.ville }}</span>
                    </div>
                    <div class="ir">
                        <span class="ir-l">Adresse</span>
                        <span class="ir-v">{{ commande.adresseLivraison }}</span>
                    </div>
                    <div class="ir">
                        <span class="ir-l">Code postal</span>
                        <span class="ir-v">{{ commande.codePostal }}</span>
                    </div>
                    <div class="ir">
                        <span class="ir-l">T√©l√©phone</span>
                        <span class="ir-v">{{ commande.telephone }}</span>
                    </div>
                    <div class="ir">
                        <span class="ir-l">Email</span>
                        <span class="ir-v">{{ commande.email ?? '‚Äî' }}</span>
                    </div>

                    {% if commande.estimationLivraison is defined and commande.estimationLivraison %}
                        {% set mins = commande.estimationLivraison %}
                        <div class="est-box">
                            <i class="bi bi-clock-fill"></i>
                            {% if mins < 60 %}
                                Livraison estim√©e : {{ mins }} min
                            {% else %}
                                Livraison estim√©e : {{ (mins / 60)|round(0,'floor') }}h{{ mins % 60 > 0 ? '%02d'|format(mins % 60) : '' }}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- SUIVI EN TEMPS R√âEL -->
            <div class="cc">
                <div class="cc-head">
                    <i class="bi bi-geo-alt"></i> Suivi de commande
                    {% if commande.statut != 'annulee' and commande.statut != 'livree' %}
                        <span class="live-dot"></span>
                    {% endif %}
                </div>
                <div class="cc-body">

                    {% if commande.statut == 'annulee' %}

                        <div class="t-step cancelled">
                            <div class="t-dot"><i class="bi bi-x-lg"></i></div>
                            <div class="t-info">
                                <div class="t-lbl">Commande annul√©e</div>
                                <div class="t-desc" style="color:#e11d48;">Cette commande a √©t√© annul√©e.</div>
                            </div>
                        </div>

                    {% else %}

                    {% set steps = [
                        {key:'en_attente',     icon:'bi-hourglass-split', lbl:'En attente',       desc:'Commande re√ßue, en attente de validation'},
                        {key:'confirmee',      icon:'bi-check-circle',    lbl:'Confirm√©e',         desc:'Votre commande a √©t√© valid√©e'},
                        {key:'en_preparation', icon:'bi-box-seam',        lbl:'En pr√©paration',    desc:'Pr√©paration de votre colis en cours'},
                        {key:'prete',          icon:'bi-bag-check',       lbl:'Pr√™te √† exp√©dier',  desc:'Votre colis est pr√™t'},
                        {key:'en_livraison',   icon:'bi-truck',           lbl:'En livraison',      desc:'Votre colis est en route'},
                        {key:'livree',         icon:'bi-check2-all',      lbl:'Livr√©e ‚úì',          desc:'Commande livr√©e avec succ√®s'},
                    ] %}

                    <div class="track-wrap">
                        {% for i, step in steps %}
                            {% set isDone = i < currentIdx %}
                            {% set isCurr = i == currentIdx %}
                            <div class="t-step {{ isDone ? 'done' : '' }} {{ isCurr ? 'curr' : '' }}">
                                <div class="t-dot"><i class="bi {{ step.icon }}"></i></div>
                                <div class="t-info">
                                    <div class="t-lbl">{{ step.lbl }}</div>
                                    <div class="t-desc">{{ step.desc }}</div>
                                    {% if isCurr %}
                                        <div class="t-date">
                                            {{ commande.dateCreation ? commande.dateCreation|date('d/m/Y H:i') : '' }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    {% endif %}

                </div>
            </div>

        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL ANNULATION PROFESSIONNELLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% if commande.statut == 'en_attente' %}
<div class="an-overlay" id="anOverlay">
    <div class="an-modal">
        <div class="an-top">
            <div class="an-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
            <h4>Annuler la commande ?</h4>
            <p>Cette action est irr√©versible.</p>
        </div>
        <div class="an-body">
            <div class="an-ref">
                <i class="bi bi-receipt" style="color:#00B37E;flex-shrink:0;"></i>
                <span>
                    Commande : <strong>{{ commande.reference }}</strong>
                    &nbsp;¬∑&nbsp;
                    <strong>{{ (commande.totalPrix + commande.fraisLivraison)|number_format(3,',','') }} TND</strong>
                </span>
            </div>
            <div class="an-warn">
                <i class="bi bi-exclamation-triangle-fill" style="flex-shrink:0;margin-top:1px;"></i>
                <span>
                    En annulant, votre commande sera d√©finitivement supprim√©e.
                    {% if commande.modePaiement != 'especes' %}
                        Un remboursement sera trait√© sous 3‚Äì5 jours ouvrables.
                    {% endif %}
                </span>
            </div>
            <div class="an-btns">
                <button class="btn-an-no" onclick="closeAnnul()">
                    <i class="bi bi-arrow-left"></i> Non, garder
                </button>
                <form method="POST" action="{{ path('client_commande_annuler', {'id': commande.id}) }}">
                    <input type="hidden" name="_token" value="{{ csrf_token('annuler' ~ commande.id) }}">
                    <button type="submit" class="btn-an-yes">
                        <i class="bi bi-x-circle-fill"></i> Oui, annuler
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function openAnnul() { document.getElementById('anOverlay').classList.add('open'); }
function closeAnnul() { document.getElementById('anOverlay').classList.remove('open'); }
document.getElementById('anOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeAnnul();
});
</script>
{% endif %}

{% endblock %}
