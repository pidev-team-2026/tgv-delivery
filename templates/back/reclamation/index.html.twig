{% extends 'baseback.html.twig' %}

{% block title %}Réclamations - Admin{% endblock %}
{% block page_title %}Réclamations{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item">Liste</li>
{% endblock %}

{% block body %}
<div class="card stretch stretch-full">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="card-title mb-0">Liste des réclamations</h5>
        <form method="get" id="form-search-back" class="d-flex gap-2 flex-wrap align-items-center">
            <div class="input-group" style="max-width: 280px;">
                <input type="text" name="search" value="{{ search }}" id="input-search-back" class="form-control" placeholder="Rechercher (sujet, message, client)...">
                <button type="submit" class="btn btn-primary"><i class="feather-search"></i></button>
            </div>
            <select name="sort_by" class="form-select" style="width: auto;" onchange="this.form.submit()">
                <option value="createdAt" {{ sort_by == 'createdAt' ? 'selected' : '' }}>Date création</option>
                <option value="updatedAt" {{ sort_by == 'updatedAt' ? 'selected' : '' }}>Date modification</option>
                <option value="subject" {{ sort_by == 'subject' ? 'selected' : '' }}>Sujet</option>
                <option value="status" {{ sort_by == 'status' ? 'selected' : '' }}>Statut</option>
            </select>
            <select name="sort_order" class="form-select" style="width: auto;" onchange="this.form.submit()">
                <option value="DESC" {{ sort_order == 'DESC' ? 'selected' : '' }}>Descendant</option>
                <option value="ASC" {{ sort_order == 'ASC' ? 'selected' : '' }}>Ascendant</option>
            </select>
        </form>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr class="border-b">
                        <th>Client</th>
                        <th>Sujet</th>
                        <th>Statut</th>
                        <th>Date</th>
                        <th>Réponses</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reclamation in reclamations %}
                        <tr>
                            <td>
                                <div>
                                    <span class="d-block fw-bold">{{ reclamation.user.name }}</span>
                                    <span class="fs-12 text-muted">{{ reclamation.user.email }}</span>
                                </div>
                            </td>
                            <td>{{ reclamation.subject }}</td>
                            <td>
                                {% set status_class = {
                                    'open': 'warning',
                                    'in_progress': 'info',
                                    'closed': 'success'
                                } %}
                                <span class="badge bg-{{ status_class[reclamation.status] ?? 'secondary' }}">{{ reclamation.statusLabel }}</span>
                            </td>
                            <td>{{ reclamation.createdAt|date('d/m/Y H:i') }}</td>
                            <td>{{ reclamation.reponses|length }}</td>
                            <td class="text-end">
                                <a href="{{ path('app_back_reclamation_show', {id: reclamation.id}) }}" class="btn btn-sm btn-outline-primary">Voir</a>
                                {% if reclamation.reponses|length == 0 %}
                                    <a href="{{ path('app_back_reclamation_edit', {id: reclamation.id}) }}" class="btn btn-sm btn-outline-secondary">Modifier</a>
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">Aucune réclamation</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
(function() {
    var form = document.getElementById('form-search-back');
    var input = document.getElementById('input-search-back');
    if (!form || !input) return;
    var debounce = null;
    input.addEventListener('input', function() {
        clearTimeout(debounce);
        debounce = setTimeout(function() { form.submit(); }, 400);
    });
})();
</script>
{% endblock %}
